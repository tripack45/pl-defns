\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{labelled-rules}[Labelled Inference Rules]

\RequirePackage{xparse}
\RequirePackage{mathpartir}

%% Rules definition/reference tools
%% Sourced from Grant Iraci

\newcommand{\xref}{\nameref}
\makeatletter
\newcommand\xlabel[2][]{\phantomsection\def\@currentlabelname{#1}\label{#2}}
\makeatother

\newenvironment{rules}[1][{}]{\begin{mathpar}}{\end{mathpar}}

%% This puts the name on the top
\NewDocumentCommand{\defrule}{o o m m}{
  \inferrule*[rightskip=2em,lab=\IfNoValueTF{#1}{}{[#1]}]
  { #3 }
  { #4 }
  \IfNoValueTF{#2}{}{\xlabel[#1]{\ifdefined\InApx{apx:}\else\fi#2}}
}

\NewDocumentCommand{\rulecaption}{m}{{\hbox to 2cm {\textsc{[#1]}\hfil}}}

\NewDocumentCommand{\defsteprule}{o o m m m m}
{\IfNoValueF{#1}{\rulecaption{#1}}%
\ensuremath{{#3}\LLStepsTo{#4}{#5} {#6}}%
\IfNoValueF{#2}{\xlabel[#1]{#2}}}

\NewDocumentCommand{\defsensorrule}{o o m m}
{\IfNoValueTF{#1}{}{\hbox to 1.5cm {\textsc{[#1]}\hfil}}
\ensuremath{{\hbox to 3cm {\ensuremath{#3}\hfil}} \quad\slash\quad {#4}}
\IfNoValueTF{#2}{}{\xlabel[#1]{#2}}}

\NewDocumentCommand{\defruler}{o o m m}{
  \inferrule*[right={\IfNoValueTF{#1}{}{[#1]}}]
  { #3 }
  { #4 }
  \IfNoValueTF{#2}{}{\xlabel[#1]{#2}}
}

\NewDocumentCommand{\dottedInferrule}{o o m m}{
  \inferrule*[fraction={\cdot\cdots\cdot},rightskip=2em,lab=\IfNoValueTF{#1}{}{[#1]}]
  {#3}{#4}
  \IfNoValueTF{#2}{}{\xlabel[#1]{\ifdefined\InApx{apx:}\else\fi#2}}
}

\NewDocumentCommand{\dottedInferruler}{o o m m}{
  \inferrule*[fraction={\cdot\cdots\cdot},right={\IfNoValueTF{#1}{}{[#1]}}]
  {#3}{#4}
  \IfNoValueTF{#2}{}{\xlabel[#1]{\ifdefined\InApx{apx:}\else\fi#2}}
}



\NewDocumentCommand{\ruleref}{m}{{[\textsc{\xref{#1}}]}}